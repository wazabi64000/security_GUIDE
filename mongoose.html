<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mongoose sécurisé avec Node.js (ESM)</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Navigation -->
  <nav style="background:#007acc; padding:10px;">
    <a href="index.html" style="color:#fff; text-decoration:none; margin-right:15px;">Accueil</a>
    <a href="helmet.html" style="color:#fff; text-decoration:none; margin-right:15px;">Helmet</a>
    <a href="rate-limit.html" style="color:#fff; text-decoration:none; margin-right:15px;">Rate Limit</a>
    <a href="cors.html" style="color:#fff; text-decoration:none; margin-right:15px;">CORS</a>
    <a href="joi.html" style="color:#fff; text-decoration:none; margin-right:15px;">Joi</a>
    <a href="csurf.html" style="color:#fff; text-decoration:none; margin-right:15px;">CSRF</a>
    <a href="xss-clean.html" style="color:#fff; text-decoration:none; margin-right:15px;">XSS Clean</a>
    <a href="express-session.html" style="color:#fff; text-decoration:none; margin-right:15px;">Sessions</a>
    <a href="jsonwebtoken.html" style="color:#fff; text-decoration:none; margin-right:15px;">JWT</a>
    <a href="bcrypt.html" style="color:#fff; text-decoration:none; margin-right:15px;">Bcrypt</a>
    <a href="mongoose.html" style="color:#fff; text-decoration:none; margin-right:15px; font-weight:bold;">Mongoose</a>
    <a href="mysql2.html" style="color:#fff; text-decoration:none; margin-right:15px;">MySQL2</a>
    <a href="winston.html" style="color:#fff; text-decoration:none;">Winston</a>
  </nav>

  <main>
    <h1>Utilisation sécurisée de <code>mongoose</code> avec Node.js (ESM)</h1>

    <p><code>mongoose</code> est une bibliothèque ODM pour MongoDB, facilitant la gestion des données et la définition de schémas.</p>

    <h2>Installation</h2>
    <pre><code>npm install mongoose bcrypt</code></pre>

    <h2>Connexion à MongoDB (ESM)</h2>
    <pre><code>import mongoose from 'mongoose';

try {
  await mongoose.connect('mongodb://localhost:27017/maBase', {
    useNewUrlParser: true,
    useUnifiedTopology: true
  });
  console.log('Connexion à MongoDB réussie');
} catch (err) {
  console.error('Erreur connexion MongoDB :', err);
}</code></pre>

    <h2>Définition d’un schéma sécurisé</h2>
    <pre><code>import bcrypt from 'bcrypt';

const userSchema = new mongoose.Schema({
  username: { type: String, required: true, unique: true, minlength: 3, maxlength: 30 },
  email: { type: String, required: true, unique: true, match: /.+\@.+\..+/ },
  passwordHash: { type: String, required: true },
  createdAt: { type: Date, default: Date.now }
});

// Middleware pour hasher le mot de passe avant sauvegarde
userSchema.pre('save', async function(next) {
  if (this.isModified('passwordHash')) {
    const salt = await bcrypt.genSalt(10);
    this.passwordHash = await bcrypt.hash(this.passwordHash, salt);
  }
  next();
});

const User = mongoose.model('User', userSchema);</code></pre>

    <h2>Exemple de création d’utilisateur</h2>
    <pre><code>async function createUser() {
  try {
    const user = new User({
      username: 'toto',
      email: 'toto@example.com',
      passwordHash: 'monMotDePasse123'
    });
    await user.save();
    console.log('Utilisateur créé');
  } catch (error) {
    console.error('Erreur création utilisateur :', error.message);
  }
}

createUser();</code></pre>

    <h2>Bonnes pratiques de sécurité</h2>
    <ul>
      <li><strong>Validation stricte :</strong> Utilisez les règles de schéma pour filtrer les données.</li>
      <li><strong>Hashage des mots de passe :</strong> Ne stockez jamais les mots de passe en clair.</li>
      <li><strong>Connexion sécurisée :</strong> En production, utilisez TLS/SSL et variables d’environnement pour les credentials.</li>
      <li><strong>Limiter les champs retournés :</strong> Ne retournez jamais le hash des mots de passe ou données sensibles.</li>
      <li><strong>Gestion des erreurs :</strong> Capturez toujours les erreurs pour éviter les fuites d’information.</li>
    </ul>

    <p>Combinez <code>mongoose</code> avec une validation côté serveur (ex : Joi) et un système d’authentification sécurisé pour un projet complet et sûr.</p>
  </main>
</body>
</html>
